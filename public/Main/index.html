<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaborTrack</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

</head>
<body>
    <!-- NAVEGATION BAR -->
    <div class="nav-bar-container">
        <nav class="nav-bar">
            <div class="nav-logo">
                <h1>LaborTrack</h1>
            </div>
            <ul class="nav-links">
                <li><a href="#home">Home</a></li>
                <li><a href="">Logout</a></li>
            </ul>
        </nav>
    </div>
    <!-- MAIN CONTENT -->
     <div class="main-content">
         <!-- LEFT PANEL -->
        <div class="left-panel-container">
            <a href="../Add-Employee/index.html"><button class="add-button">+ Add Employee</button></a>           
            <a href="../Delete-Employee/index.html"><button class="delete-button">- Delete Employee</button></a>
        </div>
        <!-- MIDDLE PANEL -->
        <div id="employeeCards" class="middle-panel-container">
            <!-- <div data-employee-id="101" class="employee-card">
                <img src="../Images/Screenshot 2024-02-27 225308.png" alt="Employee Photo" class="employee-photo">
                <div class="employee-info">
                    <h3>John Markien</h3>
                    <p>Software Engineer</p>
                    <button class="punch-button">Punch In</button>
                </div> -->

                <!-- Dynamic employee cards will be inserted here -->
            <!-- </div> -->
            
        </div>
        <!-- RIGHT PANEL -->
        <div class="right-panel-container">
            <h2 id="punchInTime">Punch-In: --:--</h2>
            <h2 id="punchDuration">Duration: --:--</h2>
            <p id="activeEmployee">Active Employee</p>
        </div>
     </div>

     <script>
        let activeTimer = null;
        let punchStartTime = null;
        const punchInEl = document.getElementById("punchInTime");
        const durationEl = document.getElementById("punchDuration");
        const activeEmpEl = document.getElementById("activeEmployee");

        function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        async function loadEmployees() {
        const companyId = localStorage.getItem("companyId");
        if (!companyId) {
            alert("You must be loggedIn.");
            return;
        }

        const response = await fetch(`http://localhost:8080/employees?companyId=${companyId}`);
        const employees = await response.json();
        const container = document.getElementById("employeeCards");
        container.innerHTML = "";

        employees.forEach(emp => {
            const card = document.createElement("div");
            card.className = "employee-card";
            card.setAttribute("data-employee-id", emp.employeeID);

            card.innerHTML = `
            <img src="../Images/default-user.png" class="employee-photo">
            <div class="employee-info">
                <h3>${emp.person.name}</h3>
                <p>${emp.jobDetails.position}</p>
                <button class="punch-button">Punch In</button>
            </div>
            `;

            // Single Click → update punch status on right panel
            card.addEventListener("click", e => {
            if (!e.target.classList.contains("punch-button")) {
                punchInEl.innerText = "Punch-In: --:--";
                durationEl.innerText = "Duration: --:--";
                activeEmpEl.innerText = `Employee #${emp.employeeID} - ${emp.person.name}`;

            }
            });

            // Double Click → go to employee info page
            card.addEventListener("dblclick", () => {
            localStorage.setItem("selectedEmployee", JSON.stringify(emp));
            window.location.href = "../EmployeeInfo/index.html";
            });

            // Punch Button logic
            const punchBtn = card.querySelector(".punch-button");
            punchBtn.addEventListener("click", async event => {
            event.stopPropagation();
            const now = new Date();
            const punchData = {
                employeeId: emp.employeeID,
                punchIn: now.toISOString(),
                punchOut: now.toISOString()
            };

            const res = await fetch("http://localhost:8080/punch", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(punchData)
            });

            if (!res.ok) {
                const err = await res.text();
                alert("Failed to punch: " + err);
                return;
            }

            if (punchBtn.innerText === "Punch In") {
                punchBtn.innerText = "Punch Out";
                punchStartTime = now;
                punchInEl.innerText = `Punch-In: ${formatTime(now)}`;
                document.querySelector(".right-panel-container p").innerText = `Employee #${emp.employeeID} - ${emp.person.name}`;
                if (activeTimer) clearInterval(activeTimer);
                activeTimer = setInterval(() => {
                const diff = new Date() - punchStartTime;
                const min = Math.floor(diff / 60000);
                const sec = Math.floor((diff % 60000) / 1000);
                durationEl.innerText = `Duration: ${min}M:${sec < 10 ? '0' : ''}${sec}S`;
                }, 1000);
            } else {
                punchBtn.innerText = "Punch In";
                clearInterval(activeTimer);
                activeTimer = null;
                punchStartTime = null;
                punchInEl.innerText = "Punch-In: --:--";
                durationEl.innerText = "Duration: --:--";
                activeEmpEl.innerText = "Active Employee";
            }
            });

            container.appendChild(card);
        });
        }

        window.onload = loadEmployees;
    </script>

</body>
</html>